<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Fractions Quest - STEM Learn Odisha</title>
 
 <link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 <link
 href="https://fonts.googleapis.com/css?family=Poppins:wght@300;400;500:600:700&display=swap"
 rel="stylesheet">
 <style>
 /* BASE STYLES */
 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 font-family: 'Poppins', sans-serif;
 }
 body {
 background-color: #f0f7ff;
 color: #1e293b;
 line-height: 1.6;
 overflow-x: hidden;
 }
 .container {
 width: 100%;
 max-width: 1200px;
 margin: 0 auto;
 padding: 0 20px;
 }
 
 /* MODAL STYLES (Big Pop-up) */
 .game-modal {
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 background: rgba(0, 0, 0, 0.7);
 display: flex;
 justify-content: center;
 align-items: center;
 z-index: 10000;
 }
 .modal-content {
 background: white;
 padding: 40px;
 border-radius: 15px;
 max-width: 600px;
 width: 90%;
 text-align: center;
 box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
 transform: scale(1);
 transition: transform 0.3s ease-out;
 position: relative;
 z-index: 10001;
 }
 .modal-title {
 color: #1a365d;
 margin-bottom: 20px;
 font-size: 1.8rem;
 }
 .modal-text {
 font-size: 1rem;
 color: #4a5568;
 margin-bottom: 25px;
 }
 .modal-btn {
 background: #4299e1;
 color: white;
 border: none;
 padding: 12px 25px;
 border-radius: 8px;
 font-size: 1rem;
 font-weight: 600;
 cursor: pointer;
 transition: background 0.3s ease;
 }
 .modal-btn:hover {
 background: #3182ce;
 }

 /* HEADER & NAVIGATION STYLES */
 header {
 background: linear-gradient(135deg, #0e2a47 0%, #1a365d 100%);
 color: white;
 padding: 15px 0;
 position: sticky;
 top: 0;
 z-index: 100;
 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
 }
 .header-content { 
 display: flex; 
 justify-content: space-between; 
 align-items: center; 
 position: relative;
 }
 
 /* LOGO: STEM Learn Odisha */
 .logo { 
 display: flex; 
 align-items: center; 
 gap: 12px; 
 flex-shrink: 0;
 }
 .logo-icon { 
 font-size: 2.2rem; 
 background: white; 
 color: #2a69ac; 
 width: 55px; 
 height: 55px; 
 border-radius: 50%; 
 display: flex; 
 align-items: center; 
 justify-content: center; 
 box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
 }
 .logo-text { 
 font-size: 1.8rem; 
 font-weight: 700; 
 line-height: 1.2;
 }
 .logo-text span { 
 color: #38b2ac; 
 font-weight: 800; 
 } 

 /* NAVIGATION AND LANGUAGE TOGETHER */
 .nav-container {
 display: flex;
 align-items: center;
 gap: 20px;
 }
 
 nav ul { 
 display: flex; 
 list-style: none; 
 gap: 25px; 
 align-items: center;
 margin: 0;
 padding: 0;
 }
 nav a { 
 color: white; 
 text-decoration: none; 
 font-weight: 500; 
 transition: all 0.3s ease; 
 padding: 8px 12px; 
 border-radius: 8px; 
 font-size: 1.05rem; 
 white-space: nowrap;
 }
 nav a:hover, nav a.active { 
 background: rgba(255, 255, 255, 0.15); 
 transform: translateY(-2px); 
 }

 /* LANGUAGE TOGGLE - MOVED TO RIGHT SIDE */
 .language-switcher {
 display: flex;
 gap: 5px;
 background: rgba(255, 255, 255, 0.1);
 border-radius: 25px;
 padding: 6px;
 border: 1px solid rgba(255, 255, 255, 0.2);
 }
 .lang-btn {
 padding: 6px 16px;
 border: none;
 background: transparent;
 border-radius: 20px;
 cursor: pointer;
 font-size: 0.9rem;
 font-weight: 500;
 transition: all 0.3s ease;
 color: white;
 }
 .lang-btn.active {
 background: rgba(255, 255, 255, 0.25);
 color: white;
 }
 .lang-btn:hover:not(.active) {
 background: rgba(255, 255, 255, 0.1);
 }

 .mobile-menu-btn { 
 display: none; 
 font-size: 1.6rem; 
 background: none; 
 border: none; 
 color: white; 
 cursor: pointer; 
 margin-left: 20px;
 }

 /* GAME LAYOUT */
 .game-header { 
 background: linear-gradient(rgba(14, 42, 71, 0.85), rgba(26, 54, 93, 0.9)), url('https://images.unsplash.com/photo-1510936111840-65e016fa050f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80');
 background-size: cover; 
 background-position: center; 
 color: white; 
 padding: 60px 0; 
 text-align: center;
 }

 /* GAME STATS STYLES - CLEANER DESIGN */
 #game-stats-container {
 background: white;
 border-radius: 10px;
 padding: 20px 25px;
 margin: -30px auto 30px;
 box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
 position: relative;
 z-index: 10;
 max-width: 95%;
 }
 .game-stats {
 display: flex;
 justify-content: space-between;
 align-items: center;
 }
 .score-container {
 display: flex;
 align-items: center;
 gap: 15px;
 }
 .score, .level-info {
 background: #f7fafc;
 padding: 12px 20px;
 border-radius: 8px;
 border-left: 4px solid #4299e1;
 min-width: 180px;
 }
 .level-info {
 border-left-color: #38a169;
 }
 .score-value, .level-value {
 font-size: 1.4rem;
 font-weight: 700;
 color: #1a365d;
 display: block;
 margin-top: 5px;
 }
 .score-label, .level-label {
 font-size: 0.9rem;
 color: #4a5568;
 font-weight: 500;
 display: block;
 }
 .progress-container {
 width: 100%;
 background: #e2e8f0;
 border-radius: 10px;
 height: 12px;
 margin-top: 15px;
 overflow: hidden;
 }
 .progress-bar {
 background: linear-gradient(to right, #4299e1, #38a169);
 height: 100%;
 border-radius: 10px;
 transition: width 0.5s ease;
 }

 /* LEVEL CARD ALIGNMENT FIX */
 .level-selection { 
 display: flex; 
 justify-content: center; 
 gap: 30px; 
 padding: 40px 0; 
 flex-wrap: wrap; 
 }
 .level-card { 
 background: white; 
 border-radius: 12px; 
 box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
 padding: 30px; 
 width: 300px; 
 
 /* FIXED: Enforce vertical alignment */
 display: flex;
 flex-direction: column;
 justify-content: space-between; 
 height: 250px; /* FIXED: Consistent height */
 
 text-align: center; 
 transition: transform 0.3s ease, box-shadow 0.3s ease; 
 cursor: pointer; 
 border: 3px solid #3182ce; 
 position: relative;
 }
 .level-card:hover {
 transform: translateY(-5px);
 box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
 }
 .level-card h3 {
 margin-bottom: 5px;
 color: #1a365d;
 }
 .level-card p {
 flex-grow: 1; /* FIXED: Allows description to take up available space */
 margin-bottom: 20px;
 color: #4a5568;
 line-height: 1.5;
 }
 .level-card.locked { 
 opacity: 0.8; 
 cursor: not-allowed; 
 border-color: #e2e8f0; 
 }
 .level-card.locked .modal-btn { 
 opacity: 0.8; 
 } 
 .lock-icon {
 position: absolute;
 top: 50%;
 left: 50%;
 transform: translate(-50%, -50%);
 font-size: 3rem;
 color: #a0aec0;
 z-index: 10;
 pointer-events: none;
 }
 
 .level-container { 
 display: none; 
 flex-direction: column; 
 align-items: center; 
 padding: 40px 20px; 
 min-height: 500px; 
 }
 .feedback { 
 font-size: 1.2rem; 
 font-weight: 600; 
 margin-top: 15px; 
 }
 .feedback.correct { 
 color: #38a169; 
 }
 .feedback.wrong { 
 color: #e53e3e; 
 }
 .target-box { 
 background: #fff; 
 padding: 20px 30px; 
 border-radius: 10px; 
 border: 2px dashed #4299e1; 
 text-align: center; 
 margin-bottom: 30px;
 box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
 }
 .target-value { 
 font-size: 3rem; 
 font-weight: 700; 
 color: #1a365d; 
 }

 /* LEVEL 1: COLLECTOR STYLES */
 #level-1-collector-grid { 
 display: grid; 
 grid-template-columns: repeat(4, 1fr); 
 gap: 20px; 
 max-width: 800px; 
 margin: 30px auto; 
 }
 .fraction-visual-card { 
 border: 3px solid #e2e8f0; 
 border-radius: 12px; 
 padding: 15px; 
 cursor: pointer; 
 transition: all 0.3s ease; 
 position: relative;
 }
 .fraction-visual-card:hover { 
 transform: scale(1.05); 
 }
 .fraction-visual-card.selected { 
 border-color: #38a169; 
 background: #e6ffe6; 
 transform: scale(1.05); 
 }
 .fraction-visual-card.incorrect { 
 border-color: #e53e3e; 
 background: #ffe6e6; 
 cursor: pointer; /* FIX: Keep cursor pointer for incorrect cards */
 }
 .fraction-shape { 
 width: 80px; 
 height: 80px; 
 margin: 0 auto 10px; 
 border-radius: 50%; 
 background: #e2e8f0; 
 position: relative; 
 overflow: hidden; 
 }
 .fraction-shape.filled { 
 background: conic-gradient(#38a169 var(--fill-percent), #e2e8f0 var(--fill-percent)); 
 }

 /* LEVEL 2: PUZZLE BUILDER STYLES */
 .puzzle-interface { 
 display: flex; 
 justify-content: center; 
 gap: 40px; 
 margin-top: 30px; 
 max-width: 900px; 
 }
 .build-zone { 
 background: #e2e8f0; 
 padding: 20px; 
 border-radius: 10px; 
 border: 4px dashed #38a169; 
 min-height: 200px; 
 width: 400px; 
 display: flex; 
 flex-wrap: wrap; 
 gap: 10px; 
 align-content: flex-start; 
 }
 .piece-pool { 
 display: flex; 
 flex-wrap: wrap; 
 justify-content: center; 
 gap: 15px; 
 margin-top: 30px; 
 padding: 20px; 
 background: #fff; 
 border-radius: 10px; 
 max-width: 600px; 
 box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
 }
 .fraction-piece { 
 padding: 10px 15px; 
 background: #f6ad55; 
 color: white; 
 border-radius: 6px; 
 font-weight: 600; 
 cursor: grab; 
 transition: transform 0.2s ease; 
 }
 .fraction-piece:hover { 
 transform: scale(1.1); 
 }

 /* LEVEL 3: BATTLE STYLES */
 #battle-comparison { 
 display: flex; 
 justify-content: center; 
 align-items: center; 
 font-size: 3.5rem; 
 gap: 30px; 
 margin-bottom: 30px; 
 font-weight: 700; 
 }
 .battle-value { 
 padding: 20px; 
 background: #fff; 
 border-radius: 10px; 
 min-width: 150px; 
 text-align: center; 
 font-size: 2.5rem; 
 box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
 }
 .comparison-btn { 
 font-size: 2rem; 
 width: 80px; 
 height: 80px; 
 border-radius: 50%; 
 padding: 0; 
 transition: transform 0.2s ease; 
 }
 .comparison-btn:hover { 
 transform: scale(1.1); 
 }

 /* FOOTER */
 footer {
 background: #1a365d;
 color: white;
 padding: 30px 0;
 margin-top: 50px;
 }
 .copyright {
 text-align: center;
 color: rgba(255, 255, 255, 0.8);
 font-size: 0.9rem;
 }

 /* RESPONSIVE DESIGN */
 @media (max-width: 1100px) {
 .header-content {
 flex-wrap: wrap;
 justify-content: space-between;
 }
 .logo {
 width: 100%;
 margin-bottom: 15px;
 justify-content: center;
 }
 .nav-container {
 width: 100%;
 justify-content: center;
 }
 }

 @media (max-width: 768px) {
 .nav-container {
 flex-direction: column;
 gap: 15px;
 }
 nav ul {
 flex-direction: column;
 gap: 10px;
 align-items: center;
 }
 .language-switcher {
 margin-top: 10px;
 }
 .mobile-menu-btn {
 display: block;
 }
 nav {
 display: none;
 }
 nav.active {
 display: block;
 }
 #level-1-collector-grid { 
 grid-template-columns: repeat(2, 1fr); 
 max-width: 400px; 
 }
 .puzzle-interface { 
 flex-direction: column; 
 align-items: center; 
 }
 .build-zone { 
 width: 90%; 
 }
 .level-card { 
 width: 100%; 
 max-width: 350px; 
 }
 .game-stats {
 flex-direction: column;
 gap: 15px;
 align-items: stretch;
 }
 .score-container {
 flex-direction: column;
 gap: 10px;
 }
 .score, .level-info {
 width: 100%;
 min-width: auto;
 }
 }

 @media (max-width: 480px) {
 .logo-text {
 font-size: 1.5rem;
 }
 .logo-icon {
 width: 45px;
 height: 45px;
 font-size: 1.8rem;
 }
 #battle-comparison {
 flex-direction: column;
 gap: 15px;
 }
 .battle-value {
 min-width: 120px;
 font-size: 2rem;
 }
 }
 </style>
</head>
<body>

 <header>
 <div class="container">
 <div class="header-content">
 
 <div class="logo">
 <div class="logo-icon"><i class="fas fa-flask"></i></div>
 <div class="logo-text">STEM Learn <span style="color: #38b2ac;">Odisha</span></div>
 </div>

 <div class="nav-container">
 <nav>
 <ul>
 <li><a href="student-dashboard.html" data-translate="nav-dashboard">Dashboard</a></li>
 <li><a href="about.html" data-translate="nav-about">About</a></li>
 <li><a href="contact.html" data-translate="nav-contact">Contact</a></li>
 </ul>
 </nav>

 <!-- LANGUAGE TOGGLE MOVED HERE - BESIDE CONTACT -->
 <div class="language-switcher">
 <button class="lang-btn active" data-lang="en">English</button>
 <button class="lang-btn" data-lang="or">ଓଡ଼ିଆ</button>
 </div>

 <button class="mobile-menu-btn"><i class="fas fa-bars"></i></button>
 </div>
 </div>
 </div>
 </header>
 
 <!-- COMPLETION MODAL -->
 <div class="game-modal" id="completion-modal" style="display: none;">
 <div class="modal-content">
 <h2 class="modal-title" id="completion-title">Level 1 Complete!</h2>
 <p class="modal-text" id="completion-text">Congratulations! You earned points and unlocked the next challenge.</p>
 <button class="modal-btn" id="next-level-btn" data-i18n="btn_next_level">Go to Level Selection</button>
 </div>
 </div>
 
 <!-- GAME OVER MODAL -->
 <div class="game-modal" id="game-over-modal" style="display: none;">
 <div class="modal-content">
 <i class="fas fa-trophy" style="font-size: 3rem; color: #38a169; margin-bottom: 15px;"></i>
 <h2 class="modal-title" data-i18n="modal_gameover_title">Quest Complete!</h2>
 <p class="modal-text">
 <span data-i18n="modal_gameover_text_p1">You have mastered all three levels of the Fractions Quest! Your final score is </span>
 <span id="final-score" style="font-weight: 700; color: #1a365d;">0</span>.
 </p>
 <button class="modal-btn" onclick="location.reload()" data-i18n="btn_start_over">Start Over</button>
 </div>
 </div>
 
 <!-- GAME HEADER -->
 <section class="game-header" id="game-header">
 <div class="container">
 <h1 data-i18n="title_header">Fractions Quest: Class 6</h1>
 <p data-i18n="subtitle_header">Conquer three unique challenges to become a Fraction Master!</p>
 </div>
 </section>

 <!-- GAME STATS - CLEANER DESIGN -->
 <div class="container" id="game-stats-container">
 <div class="game-stats">
 <div class="score-container">
 <div class="score">
 <span class="score-label" data-i18n="score">Score</span>
 <span id="score" class="score-value">0</span>
 </div>
 <div class="level-info">
 <span class="level-label" data-i18n="level">Level</span>
 <span id="level-display" class="level-value">1 (Beginner)</span>
 </div>
 </div>
 <div style="flex-grow: 1; margin-left: 30px;">
 <div class="progress-container">
 <div class="progress-bar" id="progress-bar" style="width: 0%;"></div>
 </div>
 </div>
 </div>
 </div>

 <!-- LEVEL SELECTION IS NOW VISIBLE FROM THE START -->
 <div class="container level-selection" id="level-selection-container" style="display: flex;">
 <div class="level-card" id="level-card-1" data-level="1">
 <h3 data-i18n="level1_title">Level 1: Beginner</h3>
 <p data-i18n="level1_desc">Fraction Collector: Find all the visual shapes that are equivalent to the target fraction!</p>
 <button class="start-btn modal-btn" onclick="loadLevel(1)" data-i18n-start="1">Start Level 1</button>
 </div>
 <div class="level-card locked" id="level-card-2" data-level="2">
 <div class="lock-icon"><i class="fas fa-lock"></i></div> 
 <h3 data-i18n="level2_title">Level 2: Intermediate</h3>
 <p data-i18n="level2_desc">Fraction Puzzle Builder: Combine smaller pieces to construct a larger target fraction.</p>
 <button class="start-btn modal-btn" disabled data-i18n="locked">Locked</button>
 </div>
 <div class="level-card locked" id="level-card-3" data-level="3">
 <div class="lock-icon"><i class="fas fa-lock"></i></div>
 <h3 data-i18n="level3_title">Level 3: Advanced</h3>
 <p data-i18n="level3_desc">Fraction Battle: Quickly compare fractions, decimals, and percentages.</p>
 <button class="start-btn modal-btn" disabled data-i18n="locked">Locked</button>
 </div>
 </div>

 <!-- LEVEL 1 CONTAINER -->
 <div class="container level-container" id="level-1-container">
 <h2 style="margin-bottom: 20px;" data-i18n="level1_h2">Level 1: Fraction Collector - Find the Equivalent!</h2>
 <div class="target-box">
 <h3 data-i18n="level1_target">Target Fraction:</h3>
 <p id="level-1-target-fraction" class="target-value">3/4</p>
 </div>
 
 <div id="level-1-collector-grid">
 <!-- Fraction cards will be generated here -->
 </div>

 <p id="level-1-status" class="feedback" data-i18n="level1_status_initial">Click all shapes that equal the target fraction.</p>
 <button class="modal-btn" id="level-1-check-btn" style="margin-top: 20px; display: none;" data-i18n="btn_check">Check Answers</button>
 </div>

 <!-- LEVEL 2 CONTAINER -->
 <div class="container level-container" id="level-2-container">
 <h2 style="margin-bottom: 20px;" data-i18n="level2_h2">Level 2: Fraction Puzzle Builder - Build the Target!</h2>
 
 <div class="puzzle-interface">
 <div class="target-box" style="margin-bottom: 0;">
 <h3 data-i18n="level2_target">Target Fraction:</h3>
 <p id="level-2-target-fraction" class="target-value">5/6</p>
 <div style="font-size: 1.5rem; font-weight: 500; color: #4a5568; margin-top: 15px;">
 <span data-i18n="level2_current">Current Sum:</span> <span id="level-2-current-sum">0/1</span>
 </div>
 </div>
 
 <div class="build-zone" id="level-2-build-zone">
 <p style="color: #4a5568; font-style: italic; font-size: 1rem;" data-i18n="level2_drop">Drag fraction pieces here to build the sum.</p>
 </div>
 </div>

 <p id="level-2-feedback" class="feedback" style="margin-top: 20px;"></p>
 <button class="modal-btn" id="level-2-check-btn" style="margin-top: 20px;" data-i18n="btn_check">Check Puzzle</button>

 <div class="piece-pool" id="level-2-piece-pool">
 <h4 style="width: 100%; text-align: center; margin-bottom: 10px; color: #1a365d;" data-i18n="level2_pieces">Available Pieces:</h4>
 <!-- Fraction pieces will be generated here -->
 </div>
 </div>

 <!-- LEVEL 3 CONTAINER -->
 <div class="container level-container" id="level-3-container">
 <h2 style="margin-bottom: 30px;" data-i18n="level3_h2">Level 3: Fraction Battle - Which Value is Greater?</h2>
 
 <div id="battle-comparison">
 <span id="battle-value-left" class="battle-value">5/8</span>
 <span id="comparison-placeholder" style="color: #e53e3e;">?</span>
 <span id="battle-value-right" class="battle-value">3/4</span>
 </div>
 
 <div id="level-3-options" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
 <button class="comparison-btn modal-btn" data-value="<">&lt;</button>
 <button class="comparison-btn modal-btn" data-value="=">=</button>
 <button class="comparison-btn modal-btn" data-value=">">&gt;</button>
 </div>
 
 <p id="level-3-feedback" class="feedback"></p>
 <button class="modal-btn" id="level-3-next-btn" style="display: none; margin-top: 20px;" data-i18n="btn_next_c">Next Challenge</button>
 </div>

 <!-- FOOTER -->
 <footer>
 <div class="container">
 <div class="copyright">
 &copy; 2024 STEM Learn Odisha. All rights reserved.
 </div>
 </div>
 </footer>

 <script>
 // --- LANGUAGE DATA (English & Odia) ---
 const translations = {
 'en': {
 'title_header': 'Fractions Quest: Class 6',
 'subtitle_header': 'Conquer three unique challenges to become a Fraction Master!',
 'score': 'Score',
 'level': 'Level',
 'btn_start': 'Start Quest',
 'btn_next_level': 'Go to Level Selection',
 'btn_start_over': 'Start Over',
 'locked': 'Locked',
 'btn_check': 'Check Answers',
 'btn_next_c': 'Next Challenge',
 
 // Level Descriptions (Used on Level Cards)
 'level1_title': 'Level 1: Beginner',
 'level1_desc': 'Fraction Collector: Find all the visual shapes that are equivalent to the target fraction!',
 'level2_title': 'Level 2: Intermediate',
 'level2_desc': 'Fraction Puzzle Builder: Combine smaller pieces to construct a larger target fraction.',
 'level3_title': 'Level 3: Advanced',
 'level3_desc': 'Fraction Battle: Quickly compare fractions, decimals, and percentages.',
 
 // In-Game Text
 'level1_h2': 'Level 1: Fraction Collector - Find the Equivalent!',
 'level1_target': 'Target Fraction:',
 'level1_status_initial': 'Click all shapes that equal the target fraction.',
 'level1_status_partial': (count, total) => `Found ${count} out of ${total} correct visual(s). Keep looking!`,
 'level1_status_all_correct': 'Perfect! You found all correct equivalents! (+100 Pts)',
 'level1_status_wrong': 'Wrong! You clicked one or more incorrect shapes. (-25 Pts)',
 'level1_status_try_again': 'You selected wrong answers. Click on the red cards to unselect them, then select the correct ones.',
 
 'level2_h2': 'Level 2: Fraction Puzzle Builder - Build the Target!',
 'level2_target': 'Target Fraction:',
 'level2_current': 'Current Sum:',
 'level2_drop': 'Drag fraction pieces here to build the sum.',
 'level2_pieces': 'Available Pieces:',
 'level2_correct': (pts) => `Success! The sum matches the target. (+${pts} Pts)`,
 'level2_wrong_sum': (target, current) => `Incorrect. The current sum is ${current}, but the target is ${target}.`,
 
 'level3_h2': 'Level 3: Fraction Battle - Which Value is Greater?',
 'feedback_correct': (points) => `Correct! You won the battle. (+${points} Pts)`,
 'feedback_wrong': (ans) => `Incorrect. The correct symbol is ${ans}.`,
 
 // Modal Text
 'modal_complete_title_prefix': 'Level',
 'modal_complete_title_suffix': 'Complete!',
 'modal_complete_text_p1': 'Congratulations! You mastered this level and unlocked Level',
 'modal_complete_text_p2': '.',

 'modal_gameover_title': 'Quest Complete!',
 'modal_gameover_text_p1': 'You have mastered all three levels of the Fractions Quest! Your final score is ',
 },
 'or': {
 'title_header': 'ଭଗ୍ନାଂଶ ଅନୁସନ୍ଧାନ: ଷଷ୍ଠ ଶ୍ରେଣୀ',
 'subtitle_header': 'ତିନୋଟି ଅନନ୍ୟ ଚ୍ୟାଲେଞ୍ଜ ଜୟ କରନ୍ତୁ ଏବଂ ଜଣେ ଭଗ୍ନାଂଶ ମାଷ୍ଟର ହୁଅନ୍ତୁ!',
 'score': 'ସ୍କୋର',
 'level': 'ସ୍ତର',
 'btn_start': 'ଅନୁସନ୍ଧାନ ଆରମ୍ଭ କରନ୍ତୁ',
 'btn_next_level': 'ସ୍ତର ଚୟନକୁ ଯାଆନ୍ତୁ',
 'btn_start_over': 'ପୁଣି ଆରମ୍ଭ କରନ୍ତୁ',
 'locked': 'ବନ୍ଦ',
 'btn_check': 'ଉତ୍ତର ଯାଞ୍ଚ କରନ୍ତୁ',
 'btn_next_c': 'ପରବର୍ତ୍ତୀ ଚ୍ୟାଲେଞ୍ଜ',

 // Level Descriptions (Used on Level Cards)
 'level1_title': 'ସ୍ତର ୧: ଆରମ୍ଭକାରୀ',
 'level1_desc': 'ଭଗ୍ନାଂଶ ସଂଗ୍ରାହକ: ଟାର୍ଗେଟ୍ ଭଗ୍ନାଂଶ ସହିତ ସମାନ ଥିବା ସମସ୍ତ ଦୃଶ୍ୟମାନ ଆକୃତି ଖୋଜନ୍ତୁ!',
 'level2_title': 'ସ୍ତର ୨: ମଧ୍ୟମ',
 'level2_desc': 'ଭଗ୍ନାଂଶ ପଜଲ୍ ବିଲଡର୍: ଏକ ବଡ଼ ଟାର୍ଗେଟ୍ ଭଗ୍ନାଂଶ ନିର୍ମାଣ କରିବାକୁ ଛୋଟ ଖଣ୍ଡଗୁଡ଼ିକୁ ମିଶାନ୍ତୁ।',
 'level3_title': 'ସ୍ତର ୩: ଉନ୍ନତ',
 'level3_desc': 'ଭଗ୍ନାଂଶ ଯୁଦ୍ଧ: ଭଗ୍ନାଂଶ, ଦଶମିକ ଏବଂ ଶତକଡ଼ାକୁ ଶୀଘ୍ର ତୁଳନା କରନ୍ତୁ।',

 // In-Game Text
 'level1_h2': 'ସ୍ତର ୧: ଭଗ୍ନାଂଶ ସଂଗ୍ରାହକ - ସମାନତା ଖୋଜ!',
 'level1_target': 'ଟାର୍ଗେଟ୍ ଭଗ୍ନାଂଶ:',
 'level1_status_initial': 'ଟାର୍ଗେଟ୍ ଭଗ୍ନାଂଶ ସହିତ ସମାନ ସମସ୍ତ ଆକୃତି ଉପରେ କ୍ଲିକ୍ କରନ୍ତୁ।',
 'level1_status_partial': (count, total) => `${count}/${total} ଟି ସଠିକ୍ ଦୃଶ୍ୟମାନ ମିଳିଲା। ଖୋଜି ଚାଲନ୍ତୁ!`,
 'level1_status_all_correct': 'ଉତ୍କୃଷ୍ଟ! ଆପଣ ସମସ୍ତ ସଠିକ୍ ସମାନତା ପାଇଲେ! (+100 ପଏଣ୍ଟ)',
 'level1_status_wrong': 'ଭୁଲ୍! ଆପଣ ଗୋଟିଏ କିମ୍ବା ଅଧିକ ଭୁଲ୍ ଆକୃତି ଉପରେ କ୍ଲିକ୍ କଲେ। (-25 ପଏଣ୍ଟ)',
 'level1_status_try_again': 'ଆପଣ ଭୁଲ୍ ଉତ୍ତର ବାଛିଲେ। ଲାଲ୍ କାର୍ଡଗୁଡିକ ଉପରେ କ୍ଲିକ୍ କରି ସେଗୁଡିକୁ ଅନଚେକ୍ କରନ୍ତୁ, ତାପରେ ସଠିକ୍ ଗୁଡିକ ବାଛନ୍ତୁ।',
 
 'level2_h2': 'ସ୍ତର ୨: ଭଗ୍ନାଂଶ ପଜଲ୍ ବିଲଡର୍ - ଟାର୍ଗେଟ୍ ନିର୍ମାଣ କରନ୍ତୁ!',
 'level2_target': 'ଟାର୍ଗେଟ୍ ଭଗ୍ନାଂଶ:',
 'level2_current': 'ବର୍ତ୍ତମାନର ଯୋଗଫଳ:',
 'level2_drop': 'ଯୋଗଫଳ ନିର୍ମାଣ କରିବାକୁ ଏଠାକୁ ଭଗ୍ନାଂଶ ଖଣ୍ଡ ଟାଣନ୍ତୁ।',
 'level2_pieces': 'ଉପଲବ୍ଧ ଖଣ୍ଡଗୁଡ଼ିକ:',
 'level2_correct': (pts) => `ସଫଳତା! ଯୋଗଫଳ ଟାର୍ଗେଟ୍ ସହିତ ମେଳ ଖାଉଛି। (+${pts} ପଏଣ୍ଟ)`,
 'level2_wrong_sum': (target, current) => `ଭୁଲ୍। ବର୍ତ୍ତମାନର ଯୋଗଫଳ ହେଉଛି ${current}, କିନ୍ତୁ ଟାର୍ଗେଟ୍ ହେଉଛି ${target}।`,
 
 'level3_h2': 'ସ୍ତର ୩: ଭଗ୍ନାଂଶ ଯୁଦ୍ଧ - କେଉଁ ମୂଲ୍ୟ ବଡ଼?',
 'feedback_correct': (points) => `ସଠିକ୍! ଆପଣ ଯୁଦ୍ଧ ଜିତିଲେ। (+${points} ପଏଣ୍ଟ)`,
 'feedback_wrong': (ans) => `ଭୁଲ୍। ସଠିକ୍ ସଙ୍କେତ ହେଉଛି ${ans}।`,

 // Modal Text
 'modal_complete_title_prefix': 'ସ୍ତର',
 'modal_complete_title_suffix': 'ସମାପ୍ତ!',
 'modal_complete_text_p1': 'ଅଭିନନ୍ଦନ! ଆପଣ ଏହି ସ୍ତରରେ ମାଷ୍ଟର ହୋଇ ପରବର୍ତ୍ତୀ ସ୍ତର',
 'modal_complete_text_p2': 'କୁ ଅନଲକ୍ କଲେ।',
 
 'modal_gameover_title': 'ଅନୁସନ୍ଧାନ ସମାପ୍ତ!',
 'modal_gameover_text_p1': 'ଆପଣ ଭଗ୍ନାଂଶ କ୍ୱେଷ୍ଟର ତିନୋଟି ସ୍ତରରେ ମାଷ୍ଟର ହୋଇଛନ୍ତି! ଆପଣଙ୍କର ଚୂଡ଼ାନ୍ତ ସ୍କୋର ',
 }
 };
 let currentLang = 'en'; 

 // --- UTILITY FUNCTIONS ---
 function fracToDec(value) {
 value = String(value).trim();
 if (value.endsWith('%')) {
 return parseFloat(value) / 100;
 }
 if (value.includes('/')) {
 const parts = value.split(' ');
 if (parts.length === 2) { 
 const whole = parseFloat(parts[0]);
 const frac = parts[1].split('/');
 return whole + (parseFloat(frac[0]) / parseFloat(frac[1]));
 }
 const fracParts = value.split('/');
 return parseFloat(fracParts[0]) / parseFloat(fracParts[1]);
 }
 return parseFloat(value);
 }

 function fractionToPercentFill(fraction) {
 const dec = fracToDec(fraction);
 return (dec * 100).toFixed(1);
 }

 function gcd(a, b) {
 return b ? gcd(b, a % b) : a;
 }

 // --- GAME STATE ---
 let score = 0;
 const totalLevels = 3;
 let currentLevel = 0;
 let levelStatus = {
 1: { status: 'unlocked', progress: 0 },
 2: { status: 'locked', progress: 0 },
 3: { status: 'locked', progress: 0 }
 };

 // --- NEW GAME DATA ---
 const fractionGameData = {
 1: [ 
 { id: 1, target: "3/4", visuals: ["3/4", "6/8", "9/12"], distractors: ["2/3", "4/5", "1/2"] },
 { id: 2, target: "1/2", visuals: ["1/2", "2/4", "5/10"], distractors: ["1/3", "3/5", "2/8"] },
 { id: 3, target: "2/5", visuals: ["2/5", "4/10", "6/15"], distractors: ["1/4", "3/8", "3/6"] },
 { id: 4, target: "1/3", visuals: ["1/3", "2/6", "3/9"], distractors: ["2/5", "4/12", "1/4"] },
 ],
 2: [ 
 { target: "5/6", available: ["1/6", "2/6", "3/6", "1/6", "1/6"] }, 
 { target: "7/8", available: ["1/8", "1/8", "3/8", "2/8", "2/8"] },
 { target: "4/5", available: ["1/5", "1/5", "2/5", "3/5", "1/5"] },
 { target: "3/4", available: ["1/4", "1/4", "1/4", "2/4", "3/4"] },
 ],
 3: [
 { v1: "5/8", v2: "3/4", ans: "<" },
 { v1: "7/5", v2: "1 1/2", ans: ">" }, 
 { v1: "0.5", v2: "3/5", ans: "<" }, 
 { v1: "25%", v2: "1/4", ans: "=" }, 
 { v1: "9/10", v2: "85%", ans: ">" }, 
 { v1: "0.8", v2: "4/5", ans: "=" }, 
 { v1: "1 3/8", v2: "1.375", ans: "=" }, 
 ]
 };
 const totalProblems1 = fractionGameData[1].length;
 const totalProblems2 = fractionGameData[2].length;
 const totalProblems3 = fractionGameData[3].length;

 // --- GLOBAL ELEMENT REFERENCES ---
 let levelContainers;
 let completionModal;
 let gameOverModal;
 let levelSelectionContainer;
 let scoreEl;
 let levelDisplayEl;
 let progressBar;

 // --- CORE GAME FUNCTIONS ---

 function updateUI() {
 const lang = currentLang;
 document.querySelectorAll('[data-i18n]').forEach(el => {
 const key = el.getAttribute('data-i18n');
 el.innerHTML = translations[lang][key];
 });
 
 document.querySelectorAll('[data-i18n-start]').forEach(el => {
 const levelNum = el.getAttribute('data-i18n-start');
 el.textContent = translations[lang]['btn_start'].replace('Quest', `Level ${levelNum}`);
 });
 
 document.querySelectorAll('.lang-btn').forEach(button => {
 button.classList.remove('active');
 });
 document.querySelector(`.lang-btn[data-lang="${lang}"]`).classList.add('active');

 if (currentLevel > 0) {
 const levelNameKey = `level${currentLevel}_title`;
 const levelName = translations[lang][levelNameKey].includes(':') 
 ? translations[lang][levelNameKey].split(':').pop().trim()
 : translations[lang][levelNameKey];
 levelDisplayEl.textContent = `${currentLevel} (${levelName})`;
 }
 scoreEl.textContent = score;
 }

 function setLanguage(lang) {
 currentLang = lang;
 updateUI();
 
 // Re-render current problem specific elements for language update
 if (currentLevel === 2) {
 const dropZone = document.getElementById('level-2-build-zone');
 if(dropZone.children.length === 0 || (dropZone.children.length === 1 && dropZone.querySelector('p[data-i18n="level2_drop"]'))) {
 dropZone.innerHTML = `<p style="color: #4a5568; font-style: italic; font-size: 1rem;" data-i18n="level2_drop">${translations[currentLang]['level2_drop']}</p>`;
 }
 const poolTitle = document.getElementById('level-2-piece-pool').querySelector('h4');
 if (poolTitle) {
 poolTitle.textContent = translations[currentLang]['level2_pieces'];
 }
 }
 }

 function updateScore(points) {
 score += points;
 scoreEl.textContent = score;
 }

 function updateProgress(current, total) {
 const percentage = total === 0 ? 0 : (current / total) * 100;
 progressBar.style.width = `${percentage}%`;
 }

 function showLevelSelection() {
 levelContainers.forEach(c => c.style.display = 'none');
 levelSelectionContainer.style.display = 'flex'; 
 currentLevel = 0;
 updateUI();
 }

 function loadLevel(level) {
 if (levelStatus[level].status === 'locked') return; 

 levelSelectionContainer.style.display = 'none';
 levelContainers.forEach(c => c.style.display = 'none');
 document.getElementById(`level-${level}-container`).style.display = 'flex';

 currentLevel = level;
 updateUI(); 

 if (level === 1) initLevel1();
 if (level === 2) initLevel2();
 if (level === 3) initLevel3();
 }

 function levelCompleted() {
 const oldLevel = currentLevel;
 levelStatus[oldLevel].status = 'complete';
 updateScore(150); // Bonus points for finishing a level
 updateProgress(100, 100); 

 if (oldLevel === totalLevels) {
 showGameOverModal();
 return;
 }

 const nextLevel = oldLevel + 1;
 levelStatus[nextLevel].status = 'unlocked';
 
 const nextLevelCard = document.getElementById(`level-card-${nextLevel}`);
 if (nextLevelCard) {
 nextLevelCard.classList.remove('locked');
 const lockIcon = nextLevelCard.querySelector('.lock-icon');
 if (lockIcon) lockIcon.style.display = 'none';
 const nextLevelBtn = nextLevelCard.querySelector('.start-btn');
 if (nextLevelBtn) {
 nextLevelBtn.textContent = translations[currentLang]['btn_start'].replace('Quest', `Level ${nextLevel}`);
 nextLevelBtn.disabled = false;
 nextLevelBtn.onclick = () => loadLevel(nextLevel);
 }
 }

 document.getElementById('completion-title').textContent = 
 `${translations[currentLang]['modal_complete_title_prefix']} ${oldLevel} ${translations[currentLang]['modal_complete_title_suffix']}`;
 document.getElementById('completion-text').textContent = 
 `${translations[currentLang]['modal_complete_text_p1']} ${nextLevel}${translations[currentLang]['modal_complete_text_p2']}`;
 
 completionModal.style.display = 'flex';
 }
 
 function showGameOverModal() {
 document.getElementById('final-score').textContent = score;
 gameOverModal.style.display = 'flex';
 }

 // --- LEVEL 1: FRACTION COLLECTOR LOGIC ---
 let level1_problems = [];
 let currentProblem1Index = 0;
 let selectedVisuals = [];

 function initLevel1() {
 level1_problems = fractionGameData[1].sort(() => Math.random() - 0.5);
 currentProblem1Index = 0;
 loadProblem1();
 }

 function loadProblem1() {
 if (currentProblem1Index >= totalProblems1) {
 levelCompleted();
 return;
 }

 const pData = level1_problems[currentProblem1Index];
 selectedVisuals = [];
 
 document.getElementById('level-1-target-fraction').textContent = pData.target;
 document.getElementById('level-1-status').textContent = translations[currentLang]['level1_status_initial'];
 document.getElementById('level-1-status').classList.remove('correct', 'wrong');
 
 const checkBtn = document.getElementById('level-1-check-btn');
 checkBtn.style.display = 'none';
 checkBtn.onclick = null;
 checkBtn.addEventListener('click', checkAnswer1, { once: true });

 const grid = document.getElementById('level-1-collector-grid');
 grid.innerHTML = '';

 const allVisuals = [...pData.visuals.map(v => ({ val: v, type: 'correct' })), 
 ...pData.distractors.map(v => ({ val: v, type: 'wrong' }))];
 
 allVisuals.sort(() => Math.random() - 0.5);

 allVisuals.forEach((item, index) => {
 const card = document.createElement('div');
 card.classList.add('fraction-visual-card');
 card.dataset.value = item.val;
 card.dataset.type = item.type;
 
 const shape = document.createElement('div');
 shape.classList.add('fraction-shape', 'filled');
 shape.style.setProperty('--fill-percent', `${fractionToPercentFill(item.val)}%`);
 
 const label = document.createElement('p');
 label.textContent = item.val;

 card.appendChild(shape);
 card.appendChild(label);
 grid.appendChild(card);
 
 card.addEventListener('click', toggleSelection1);
 });
 updateProgress(currentProblem1Index, totalProblems1);
 }

 function toggleSelection1(e) {
 const card = e.currentTarget;
 
 // FIX: Allow toggling even if card is marked as incorrect
 if (card.classList.contains('incorrect')) {
 // If clicking on an incorrect card, unselect it
 card.classList.remove('incorrect');
 card.classList.remove('selected');
 const value = card.dataset.value;
 selectedVisuals = selectedVisuals.filter(v => v !== value);
 
 // Update feedback message
 document.getElementById('level-1-status').textContent = translations[currentLang]['level1_status_try_again'];
 document.getElementById('level-1-status').classList.add('wrong');
 
 // Show check button if there are still selections
 document.getElementById('level-1-check-btn').style.display = selectedVisuals.length > 0 ? 'block' : 'none';
 return;
 }

 // Normal selection toggle
 card.classList.toggle('selected');
 const value = card.dataset.value;

 if (card.classList.contains('selected')) {
 selectedVisuals.push(value);
 } else {
 selectedVisuals = selectedVisuals.filter(v => v !== value);
 }
 
 document.getElementById('level-1-check-btn').style.display = selectedVisuals.length > 0 ? 'block' : 'none';
 }

 function checkAnswer1() {
 const pData = level1_problems[currentProblem1Index];
 const allCards = document.querySelectorAll('#level-1-collector-grid .fraction-visual-card');
 const feedbackEl = document.getElementById('level-1-status');
 let isCorrect = true;
 let foundCorrect = 0;
 let clickedWrong = false;

 allCards.forEach(card => {
 const isSelected = card.classList.contains('selected');
 const isVisualCorrect = pData.visuals.includes(card.dataset.value);

 // FIX: Don't remove event listeners - allow correction
 if (isSelected && isVisualCorrect) {
 foundCorrect++;
 card.style.borderColor = '#38a169';
 card.classList.add('selected');
 } else if (isSelected && !isVisualCorrect) {
 clickedWrong = true;
 card.classList.add('incorrect'); 
 card.classList.remove('selected'); // Remove selected class
 isCorrect = false;
 } else if (!isSelected && isVisualCorrect) {
 isCorrect = false;
 card.style.borderColor = '#4299e1';
 }
 });

 if (isCorrect && foundCorrect === pData.visuals.length) {
 feedbackEl.textContent = translations[currentLang]['level1_status_all_correct'];
 feedbackEl.classList.add('correct');
 feedbackEl.classList.remove('wrong');
 updateScore(100);
 
 // Disable all cards after correct answer
 allCards.forEach(card => {
 card.removeEventListener('click', toggleSelection1);
 card.style.cursor = 'default';
 });
 
 document.getElementById('level-1-check-btn').style.display = 'none';

 setTimeout(() => {
 currentProblem1Index++;
 loadProblem1();
 }, 1500);
 } else {
 if (clickedWrong) {
 feedbackEl.textContent = translations[currentLang]['level1_status_try_again'];
 updateScore(-25);
 } else {
 feedbackEl.textContent = translations[currentLang]['level1_status_partial'](foundCorrect, pData.visuals.length);
 }
 feedbackEl.classList.add('wrong');
 feedbackEl.classList.remove('correct');
 
 // FIX: Don't disable cards - allow correction
 // Keep event listeners attached so user can correct their answers
 const checkBtn = document.getElementById('level-1-check-btn');
 checkBtn.onclick = null;
 checkBtn.addEventListener('click', checkAnswer1, { once: true });
 checkBtn.style.display = 'block';
 }
 }

 // --- LEVEL 2: PUZZLE BUILDER LOGIC ---
 let level2_problems = [];
 let currentProblem2Index = 0;
 let currentBuildSum = 0; 

 function initLevel2() {
 level2_problems = fractionGameData[2].sort(() => Math.random() - 0.5); 
 currentProblem2Index = 0;
 loadProblem2();
 }

 function loadProblem2() {
 if (currentProblem2Index >= totalProblems2) {
 levelCompleted();
 return;
 }

 const pData = level2_problems[currentProblem2Index];
 currentBuildSum = 0;
 const denominator = pData.target.split('/')[1];

 document.getElementById('level-2-target-fraction').textContent = pData.target;
 document.getElementById('level-2-current-sum').textContent = `0/${denominator}`;
 document.getElementById('level-2-feedback').textContent = '';
 document.getElementById('level-2-feedback').classList.remove('correct', 'wrong');
 
 const checkBtn = document.getElementById('level-2-check-btn');
 checkBtn.onclick = null;
 checkBtn.addEventListener('click', checkAnswer2, { once: true });
 
 // FIX: Ensure check button is visible
 checkBtn.style.display = 'block';
 
 const dropZone = document.getElementById('level-2-build-zone');
 dropZone.innerHTML = `<p style="color: #4a5568; font-style: italic; font-size: 1rem;" data-i18n="level2_drop">${translations[currentLang]['level2_drop']}</p>`;
 
 dropZone.removeEventListener('dragover', handleDragOver2);
 dropZone.removeEventListener('drop', handleDrop2);
 dropZone.addEventListener('dragover', handleDragOver2);
 dropZone.addEventListener('drop', handleDrop2);

 const piecePool = document.getElementById('level-2-piece-pool');
 piecePool.innerHTML = `<h4 style="width: 100%; text-align: center; margin-bottom: 10px; color: #1a365d;" data-i18n="level2_pieces">${translations[currentLang]['level2_pieces']}</h4>`;

 pData.available.forEach((piece, index) => {
 const pieceEl = document.createElement('div');
 pieceEl.classList.add('fraction-piece');
 pieceEl.textContent = piece;
 pieceEl.setAttribute('draggable', true);
 pieceEl.dataset.value = piece;
 pieceEl.dataset.originalIndex = index; 
 piecePool.appendChild(pieceEl);
 pieceEl.addEventListener('dragstart', handleDragStart2);
 });
 
 piecePool.removeEventListener('dragover', handleDragOver2);
 piecePool.addEventListener('dragover', handleDragOver2);
 piecePool.removeEventListener('drop', handleDropBack2);
 piecePool.addEventListener('drop', handleDropBack2);

 updateProgress(currentProblem2Index, totalProblems2);
 }

 function handleDragStart2(e) {
 e.dataTransfer.setData('text/plain', `${e.target.dataset.value}|${e.target.dataset.originalIndex}`);
 e.dataTransfer.effectAllowed = 'move';
 e.target.classList.add('dragged');
 }

 function handleDragOver2(e) {
 e.preventDefault(); 
 e.dataTransfer.dropEffect = 'move';
 }

 function handleDrop2(e) {
 e.preventDefault();
 const [droppedFraction, originalIndex] = e.dataTransfer.getData('text/plain').split('|');
 const pData = level2_problems[currentProblem2Index];
 const dropZone = document.getElementById('level-2-build-zone');
 const denominator = pData.target.split('/')[1];

 if (droppedFraction.split('/')[1] !== denominator) {
 document.getElementById('level-2-feedback').textContent = "Error: Denominators must match!";
 document.getElementById('level-2-feedback').classList.add('wrong');
 document.querySelector('.fraction-piece.dragged').classList.remove('dragged'); 
 return;
 }
 
 const originalPiece = document.querySelector(`.fraction-piece.dragged[data-value="${droppedFraction}"][data-original-index="${originalIndex}"]`);
 
 if (originalPiece && originalPiece.parentElement.id !== 'level-2-build-zone') {
 
 const prompt = dropZone.querySelector('p[data-i18n="level2_drop"]');
 if (prompt) prompt.remove();

 originalPiece.removeEventListener('dragstart', handleDragStart2);
 originalPiece.setAttribute('draggable', true); 
 originalPiece.classList.remove('dragged');
 originalPiece.classList.add('in-puzzle');
 dropZone.appendChild(originalPiece);
 
 const numerator = parseFloat(droppedFraction.split('/')[0]);
 currentBuildSum += numerator;
 document.getElementById('level-2-current-sum').textContent = `${currentBuildSum}/${denominator}`;
 document.getElementById('level-2-feedback').textContent = '';
 document.getElementById('level-2-feedback').classList.remove('correct', 'wrong');
 } else if (originalPiece) {
 originalPiece.classList.remove('dragged');
 }
 }
 
 function handleDropBack2(e) {
 e.preventDefault();
 const [droppedFraction, originalIndex] = e.dataTransfer.getData('text/plain').split('|');
 const piecePool = document.getElementById('level-2-piece-pool');
 const dropZone = document.getElementById('level-2-build-zone');
 
 const originalPiece = document.querySelector(`.fraction-piece.dragged[data-value="${droppedFraction}"][data-original-index="${originalIndex}"]`);

 if (originalPiece && originalPiece.parentElement.id === 'level-2-build-zone') {
 originalPiece.classList.remove('dragged', 'in-puzzle');
 originalPiece.setAttribute('draggable', true);
 
 originalPiece.removeEventListener('dragstart', handleDragStart2); 
 originalPiece.addEventListener('dragstart', handleDragStart2);
 
 const numerator = parseFloat(droppedFraction.split('/')[0]);
 currentBuildSum -= numerator;
 const denominator = level2_problems[currentProblem2Index].target.split('/')[1];
 document.getElementById('level-2-current-sum').textContent = `${currentBuildSum}/${denominator}`;

 const title = piecePool.querySelector('h4');
 piecePool.insertBefore(originalPiece, title ? title.nextSibling : null);
 
 if (dropZone.children.length === 0 || (dropZone.children.length === 1 && dropZone.querySelector('h4'))) {
 dropZone.innerHTML = `<p style="color: #4a5568; font-style: italic; font-size: 1rem;" data-i18n="level2_drop">${translations[currentLang]['level2_drop']}</p>`;
 }
 } else if (originalPiece) {
 originalPiece.classList.remove('dragged');
 }
 }

 function checkAnswer2() {
 const pData = level2_problems[currentProblem2Index];
 const targetNumerator = parseFloat(pData.target.split('/')[0]);
 const targetDenominator = pData.target.split('/')[1];
 const feedbackEl = document.getElementById('level-2-feedback');
 const checkBtn = document.getElementById('level-2-check-btn');

 if (currentBuildSum === targetNumerator) {
 feedbackEl.textContent = translations[currentLang]['level2_correct'](100);
 feedbackEl.classList.add('correct');
 feedbackEl.classList.remove('wrong');
 updateScore(100);
 
 document.querySelectorAll('#level-2-build-zone .fraction-piece').forEach(p => p.setAttribute('draggable', false));

 setTimeout(() => {
 currentProblem2Index++;
 loadProblem2();
 }, 1500);
 } else {
 const currentFraction = `${currentBuildSum}/${targetDenominator}`;
 feedbackEl.textContent = translations[currentLang]['level2_wrong_sum'](pData.target, currentFraction);
 feedbackEl.classList.add('wrong');
 feedbackEl.classList.remove('correct');
 
 // FIX: Re-attach the click event listener for the next attempt
 checkBtn.onclick = null;
 checkBtn.addEventListener('click', checkAnswer2, { once: true });
 }
 }

 // --- LEVEL 3: FRACTION BATTLE LOGIC ---
 let level3_problems = [];
 let currentProblem3Index = 0;

 function initLevel3() {
 level3_problems = fractionGameData[3].sort(() => Math.random() - 0.5);
 currentProblem3Index = 0;
 loadProblem3();
 }

 function loadProblem3() {
 if (currentProblem3Index >= totalProblems3) {
 levelCompleted();
 return;
 }

 const pData = level3_problems[currentProblem3Index];

 document.getElementById('battle-value-left').textContent = pData.v1;
 document.getElementById('comparison-placeholder').textContent = '?';
 document.getElementById('comparison-placeholder').style.color = '#e53e3e';
 document.getElementById('battle-value-right').textContent = pData.v2;

 document.getElementById('level-3-feedback').textContent = '';
 document.getElementById('level-3-feedback').classList.remove('correct', 'wrong');
 document.getElementById('level-3-next-btn').style.display = 'none';

 const optionBtns = document.querySelectorAll('#level-3-options button');
 optionBtns.forEach(btn => {
 btn.disabled = false;
 btn.style.background = '#4299e1';
 btn.onclick = null; 
 btn.addEventListener('click', checkAnswer3, { once: true });
 });
 
 updateProgress(currentProblem3Index, totalProblems3);
 }

 function checkAnswer3(e) {
 const selectedValue = e.target.closest('.comparison-btn').dataset.value;
 const pData = level3_problems[currentProblem3Index];
 const feedbackEl = document.getElementById('level-3-feedback');

 document.querySelectorAll('#level-3-options button').forEach(btn => btn.disabled = true);
 
 document.getElementById('comparison-placeholder').textContent = selectedValue;

 const val1Dec = fracToDec(pData.v1);
 const val2Dec = fracToDec(pData.v2);
 
 let actualAnswer = '';
 if (Math.abs(val1Dec - val2Dec) < 0.00001) { 
 actualAnswer = '=';
 } else if (val1Dec < val2Dec) {
 actualAnswer = '<';
 } else {
 actualAnswer = '>';
 }
 
 if (selectedValue === actualAnswer) {
 document.getElementById('comparison-placeholder').style.color = '#38a169';
 feedbackEl.textContent = translations[currentLang]['feedback_correct'](100);
 feedbackEl.classList.add('correct');
 feedbackEl.classList.remove('wrong');
 updateScore(100);
 } else {
 document.getElementById('comparison-placeholder').style.color = '#e53e3e';
 feedbackEl.textContent = translations[currentLang]['feedback_wrong'](actualAnswer);
 feedbackEl.classList.add('wrong');
 feedbackEl.classList.remove('correct');
 }

 document.getElementById('level-3-next-btn').style.display = 'block';
 }

 // --- INITIALIZATION ---
 
 document.addEventListener('DOMContentLoaded', () => {
 // 1. Assign global element references after DOM is loaded
 levelContainers = [
 document.getElementById('level-1-container'),
 document.getElementById('level-2-container'),
 document.getElementById('level-3-container')
 ];
 
 completionModal = document.getElementById('completion-modal');
 gameOverModal = document.getElementById('game-over-modal');
 levelSelectionContainer = document.getElementById('level-selection-container');
 scoreEl = document.getElementById('score');
 levelDisplayEl = document.getElementById('level-display');
 progressBar = document.getElementById('progress-bar');
 
 // 2. Attach event listeners
 document.getElementById('next-level-btn').addEventListener('click', () => {
 completionModal.style.display = 'none';
 showLevelSelection();
 });
 
 document.querySelectorAll('.lang-btn').forEach(button => {
 button.addEventListener('click', () => {
 setLanguage(button.getAttribute('data-lang'));
 });
 });

 document.getElementById('level-3-next-btn').addEventListener('click', () => {
 currentProblem3Index++;
 loadProblem3();
 });
 
 // 3. Mobile menu toggle
 document.querySelector('.mobile-menu-btn').addEventListener('click', function() {
 const nav = document.querySelector('nav');
 nav.classList.toggle('active');
 });
 
 // 4. Set initial state
 setLanguage('en'); 
 updateScore(0);
 
 // Level selection is now visible from the start
 levelContainers.forEach(c => c.style.display = 'none');
 // Level selection container is already visible with inline style
 });

 </script>
</body>
</html>